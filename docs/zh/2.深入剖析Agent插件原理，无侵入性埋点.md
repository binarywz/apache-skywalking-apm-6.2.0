# 深入剖析Agent插件原理

### AbstractClassEnhancePluginDefine核心实现

AbstractClassEnhancePluginDefine是所有插件的父类，SkywalkingAgent.Transformer会通过其enhanceClass()方法返回的ClassMatch对象，匹配到要增强的目标类。在不同的插件实现类中，enhanceClass()方法返回的ClassMatch对象不同，匹配到要增强的目标类。在不同的插件实现中，enhanceClass()方法返回的ClassMatch对象不同：

- Dubbo插件拦截的是`com.alibaba.dubbo.monitor.support.MonitorFilter`这个类
- Tomcat插件拦截的是`org.apache.catalina.core.StandardHostValve`这个类

完成目标类和插件类的匹配之后，会进入define()方法，其核心逻辑如下：

- 通过witnessClass()方法确定当前插件与当前拦截到的目标类版本是否匹配。若版本不匹配，则define()方法直接结束，当前插件类不会增强该类；若版本匹配，则继续后续逻辑
- 进入enhance()方法执行增强逻辑
- 设置插件增强标识